<!doctype html>
<html lang="mr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Maharashtra Saral Seva Bharti</title>
  <style>
    *{box-sizing:border-box;font-family:system-ui,Arial,sans-serif}
    body{background:#fffdf8;padding:14px;color:#111}
    h2{color:#e65100;text-align:center}
    form{max-width:900px;margin:10px auto;padding:12px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    input,textarea,select{width:100%;padding:10px;margin-bottom:8px;border-radius:6px;border:1px solid #ddd}
    .row{display:flex;gap:8px}
    .col{flex:1}
    button{background:#ff6d00;color:#fff;padding:10px;border:none;border-radius:8px;cursor:pointer}
    .small{font-size:0.9rem;color:#666}
    .list{max-width:900px;margin:12px auto}
    .item{background:#fff;padding:10px;border-radius:8px;margin-bottom:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
    .danger{background:#d32f2f}
  </style>
</head>
<body>
  <h2>Admin Panel — Job & PDF Manager (V4)</h2>

  <!-- Auth -->
  <form id="authForm" style="max-width:900px;margin:0 auto 10px;">
    <input id="passwd" type="password" placeholder="Enter Admin Password" required />
    <button type="submit">Unlock Admin</button>
    <div class="small">Admin password already set to your chosen value.</div>
  </form>

  <div id="adminArea" style="display:none">
    <!-- Job form -->
    <form id="jobForm">
      <h3>Add Job</h3>
      <input id="jobTitle" placeholder="Job Title" required/>
      <textarea id="jobDesc" placeholder="Short description" required></textarea>
      <div class="row">
        <input id="jobDate" class="col" placeholder="Last Date (eg. 20 Nov 2025)" required/>
        <select id="jobCategory" class="col">
          <option value="Govt">Govt</option>
          <option value="Police">Police</option>
          <option value="ZP">ZP</option>
          <option value="Bank">Bank</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <button id="addJobBtn" type="button">Add Job</button>
    </form>

    <!-- PDF form -->
    <form id="pdfForm" style="margin-top:12px">
      <h3>Add PDF (URL or Upload)</h3>
      <input id="pdfTitle" placeholder="PDF Title" required/>
      <input id="pdfDesc" placeholder="PDF short desc"/>
      <input id="pdfUrl" placeholder="Public PDF URL (recommended)"/>
      <input id="pdfFile" type="file" accept="application/pdf,image/*"/>
      <div class="row" style="margin-top:8px">
        <button id="addPdfBtn" type="button">Add PDF</button>
        <button id="uploadToGitBtn" type="button">(Optional) Upload file to GitHub Repo</button>
      </div>
      <div class="small">Note: Upload to GitHub requires Personal Access Token with `repo` scope. Token not saved in repo — you will be prompted and token used only in-browser.</div>
    </form>

    <div style="margin-top:16px">
      <button id="clearStorage" type="button" style="background:#888">Clear Local Storage (jobs + pdfs)</button>
    </div>

    <!-- Lists -->
    <div class="list">
      <h3>Saved Jobs</h3>
      <div id="jobsList">Loading...</div>

      <h3 style="margin-top:10px">Saved PDFs</h3>
      <div id="pdfsList">Loading...</div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const ADMIN_PASS = 'Pass@100'; // your chosen password
  // If you want GitHub upload: set these or you'll be prompted in-browser
  const GITHUB_OWNER = '<YOUR_GITHUB_USERNAME>';   // REPLACE before using GitHub upload OR leave blank to be prompted
  const GITHUB_REPO  = '<YOUR_REPO_NAME>';         // REPLACE with repo name (eg: maharashtrasaralsevabharti.github.io)
  const GITHUB_PATH  = 'job_update/uploads';       // where files will be pushed in repo
  // ==========================

  // storage keys
  const JOBS_KEY = 'ms_jobs';
  const PDFS_KEY = 'ms_pdfs';

  // helpers
  const $ = id => document.getElementById(id);
  function getJobs(){ return JSON.parse(localStorage.getItem(JOBS_KEY) || '[]'); }
  function getPdfs(){ return JSON.parse(localStorage.getItem(PDFS_KEY) || '[]'); }
  function saveJobs(j){ localStorage.setItem(JOBS_KEY, JSON.stringify(j)); }
  function savePdfs(p){ localStorage.setItem(PDFS_KEY, JSON.stringify(p)); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c])); }

  // auth
  $('authForm').addEventListener('submit', e=>{
    e.preventDefault();
    const p = $('passwd').value;
    if(p !== ADMIN_PASS){ alert('Wrong password'); return; }
    $('authForm').style.display='none'; $('adminArea').style.display='block'; renderAll();
  });

  // render lists
  function renderAll(){
    renderJobs(); renderPdfs();
  }

  function renderJobs(){
    const el = $('jobsList'); el.innerHTML='';
    const list = getJobs();
    if(!list.length){ el.innerHTML = '<div class="small">No jobs saved</div>'; return; }
    list.forEach((j,i)=>{
      const d = document.createElement('div'); d.className='item';
      d.innerHTML = `<strong>${escapeHtml(j.title)}</strong>
                     <div class="small">${escapeHtml(j.desc)}</div>
                     <div class="small">Last Date: ${escapeHtml(j.lastDate)} | Category: ${escapeHtml(j.category||'Other')}</div>`;
      const del = document.createElement('button'); del.textContent='Delete'; del.style.marginTop='6px';
      del.onclick = ()=>{ if(confirm('Delete this job?')){ list.splice(i,1); saveJobs(list); renderJobs(); } };
      d.appendChild(del); el.appendChild(d);
    })
  }

  function renderPdfs(){
    const el = $('pdfsList'); el.innerHTML='';
    const list = getPdfs();
    if(!list.length){ el.innerHTML = '<div class="small">No PDFs saved</div>'; return; }
    list.forEach((p,i)=>{
      const d = document.createElement('div'); d.className='item';
      const link = p.link ? (p.link.startsWith('data:') ? '(uploaded file)' : `<a href="${p.link}" target="_blank">Open</a>`) : '';
      d.innerHTML = `<strong>${escapeHtml(p.title)}</strong>
                     <div class="small">${escapeHtml(p.desc)}</div>
                     <div class="small">${link}</div>`;
      const del = document.createElement('button'); del.textContent='Delete'; del.style.marginTop='6px';
      del.onclick = ()=>{ if(confirm('Delete this PDF?')){ list.splice(i,1); savePdfs(list); renderPdfs(); } };
      d.appendChild(del); el.appendChild(d);
    })
  }

  // add job
  $('addJobBtn').addEventListener('click', ()=>{
    const title = $('jobTitle').value.trim();
    const desc = $('jobDesc').value.trim();
    const lastDate = $('jobDate').value.trim();
    const category = $('jobCategory').value;
    if(!title||!desc||!lastDate){ alert('Fill all fields'); return; }
    const list = getJobs(); list.unshift({title,desc,lastDate,category});
    saveJobs(list); $('jobForm').reset(); renderJobs(); notifyNewJob(title);
    alert('Job added');
  });

  // add pdf (url or upload)
  $('addPdfBtn').addEventListener('click', ()=>{
    const title = $('pdfTitle').value.trim();
    const desc = $('pdfDesc').value.trim();
    const url = $('pdfUrl').value.trim();
    const file = $('pdfFile').files[0];
    if(!title){ alert('Enter title'); return; }
    if(url){
      const list = getPdfs(); list.unshift({title,desc,link:url}); savePdfs(list); renderPdfs(); $('pdfForm').reset(); alert('PDF added via URL'); return;
    }
    if(file){
      // convert to data URL and store in localStorage
      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;
        const list = getPdfs(); list.unshift({title,desc,link:dataUrl}); savePdfs(list); renderPdfs(); $('pdfForm').reset(); alert('PDF uploaded to browser storage');
      };
      reader.readAsDataURL(file);
      return;
    }
    alert('Provide PDF URL or choose file');
  });

  // notify function: triggers browser notification + in-page toast on main page
  function notifyNewJob(title){
    try{
      // localStorage flag which main page polls
      const x = JSON.parse(localStorage.getItem('ms_jobs_notify') || '[]');
      x.unshift({title, at: new Date().toISOString()});
      localStorage.setItem('ms_jobs_notify', JSON.stringify(x));
    }catch(e){}
  }

  // Optional: Upload file to GitHub repo (requires token)
  $('uploadToGitBtn').addEventListener('click', async ()=>{
    const file = $('pdfFile').files[0];
    if(!file){ alert('Choose a file first (pdf or image)'); return; }
    const token = prompt('Paste your GitHub Personal Access Token (will be used only in this browser session). Do NOT commit this token anywhere.');
    if(!token){ alert('Token required for upload'); return; }
    // determine owner and repo
    let owner = GITHUB_OWNER, repo = GITHUB_REPO;
    if(!owner || !repo){
      owner = prompt('GitHub username (owner):'); if(!owner) return;
      repo = prompt('Repo name (eg: username.github.io):'); if(!repo) return;
    }
    const pathFolder = GITHUB_PATH || 'job_update/uploads';
    const fname = file.name;
    // read file as base64
    const b64 = await new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload = ()=> { const raw = r.result.split(',')[1]; res(raw); };
      r.onerror = rej;
      r.readAsDataURL(file);
    });
    // create endpoint
    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${pathFolder}/${encodeURIComponent(fname)}`;
    const body = {
      message: `Upload ${fname} via admin panel`,
      content: b64,
      branch: 'main'
    };
    // call GitHub API
    try{
      const resp = await fetch(apiUrl, {
        method: 'PUT',
        headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const j = await resp.json();
      if(resp.status===201 || resp.status===200){
        const url = j.content && j.content.html_url ? j.content.html_url.replace('/blob/','/raw/') : `https://raw.githubusercontent.com/${owner}/${repo}/main/${pathFolder}/${fname}`;
        // store PDF record pointing to raw URL
        const list = getPdfs(); list.unshift({title: $('pdfTitle').value || fname, desc: $('pdfDesc').value || '', link: url}); savePdfs(list); renderPdfs();
        alert('Upload successful. File URL: ' + url);
      } else {
        console.error(j);
        alert('Upload failed: ' + (j.message || JSON.stringify(j)));
      }
    }catch(err){ console.error(err); alert('Upload error: see console'); }
  });

  // clear storage
  $('clearStorage').addEventListener('click', ()=>{
    if(!confirm('Delete all saved jobs & PDFs from this browser?')) return;
    localStorage.removeItem(JOBS_KEY); localStorage.removeItem(PDFS_KEY); renderAll(); alert('Cleared');
  });

  // initial fallback: if no data in localStorage, try to fetch files (jobs.json/pdfs.json)
  (async function initialLoad(){
    const jobsLocal = getJobs();
    const pdfsLocal = getPdfs();
    if(!jobsLocal.length){
      // try fetch jobs.json
      try{ const r = await fetch('jobs.json'); if(r.ok){ const j = await r.json(); if(j.length){ saveJobs(j); } } }catch(e){}
    }
    if(!pdfsLocal.length){
      try{ const r2 = await fetch('pdfs.json'); if(r2.ok){ const p = await r2.json(); if(p.length){ savePdfs(p); } } }catch(e){}
    }
  })();
</script>
</body>
</html>
